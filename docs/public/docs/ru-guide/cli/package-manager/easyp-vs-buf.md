# EasyP против Buf: управление пакетами

[[toc]]

Этот документ даёт подробное сравнение децентрализованного подхода EasyP к управлению пакетами и централизованной модели Buf через Buf Schema Registry (BSR), чтобы помочь понять ключевые различия и выбрать подходящее решение для ваших задач.

## Сравнение архитектуры

### EasyP: децентрализованный подход на базе Git

```
┌─────────────────────────────────────────────────────────────────┐
│                     Архитектура EasyP                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Машина разработчика           Git репозитории                  │
│  ┌──────────────┐           ┌─────────────────┐                │
│  │              │  clone/   │ github.com/     │                │
│  │ ~/.easyp/    │◄─────────►│ googleapis/     │                │
│  │ cache/       │  fetch    │ googleapis      │                │
│  │              │           │                 │                │
│  │ mod/         │           ├─────────────────┤                │
│  │              │           │ company.com/    │                │
│  └──────────────┘           │ internal-protos │                │
│                              │                 │                │
│                              ├─────────────────┤                │
│                              │ gitlab.com/     │                │
│                              │ team/shared     │                │
│                              └─────────────────┘                │
│                                                                 │
│  ✅ Прямой доступ к репозиториям                                │
│  ✅ Нет единой точки отказа                                     │
│  ✅ Работает с любым Git хостингом                              │
│  ✅ Полный контроль над зависимостями                          │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### Buf: централизованный реестр (BSR)

```
┌────────────────────────────────────────────────────────────────┐
│                      Архитектура Buf                           │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  Машина разработчика               Buf Schema Registry (BSR)   │
│  ┌──────────────┐              ┌─────────────────────────────┐ │
│  │              │   push/pull  │                             │ │
│  │ ~/.cache/    │◄────────────►│  buf.build                  │ │
│  │ bufcli/      │   modules    │                             │ │
│  │              │              │ ┌─────────────────────────┐ │ │
│  │              │              │ │ googleapis/googleapis   │ │ │
│  │              │              │ ├─────────────────────────┤ │ │
│  │              │              │ │ grpc/grpc               │ │ │
│  │              │              │ ├─────────────────────────┤ │ │
│  │              │              │ │ envoyproxy/protoc-gen-  │ │ │
│  │              │              │ │ validate                │ │ │
│  └──────────────┘              │ └─────────────────────────┘ │ │
│                                │                             │ │
│                                └─────────────────────────────┘ │
│                                                                │
│  ⚠️ Централизованная зависимость                               │
│  ⚠️ Единая точка контроля                                      │
│  ⚠️ Требуется доступ к buf.build                               │
│  ⚠️ Ограничение экосистемой BSR                                │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

## Краткое резюме различий

| Аспект | EasyP | Buf |
|--------|-------|-----|
| **Архитектура** | Децентрализованная (Git) | Централизованная (реестр BSR) |
| **Источник зависимостей** | Любой Git репозиторий | Только модули BSR |
| **Единая точка отказа** | Нет | Да (buf.build) |
| **Enterprise / air‑gapped** | Полная поддержка | Требует доступа к BSR или приватного BSR |
| **Аутентификация** | Git (SSH / HTTPS) | Токены Buf + Git |
| **Vendor lock‑in** | Отсутствует | Привязка к экосистеме Buf |
| **Частные репозитории** | Нативно через Git | Нужно опубликовать в BSR |
| **Оффлайн поддержка** | Полная (через vendoring) | Ограничена (кэшированные модули) |
| **Стоимость** | Бесплатно (использует существующий Git) | Бесплатный тариф + платные планы |
| **Сложность настройки** | Минимальная | Средняя (настройка BSR) |

## Подробное сравнение возможностей

### 1. Философия управления зависимостями

#### EasyP: «Любой Git репозиторий — это пакет»
```yaml
# Прямые ссылки на Git репозитории
deps:
  - github.com/googleapis/googleapis@v1.2.3
  - gitlab.company.com/protos/internal@v2.0.1
  - git.example.com/team/shared-types@main
```

**Преимущества:**
- ✅ Использование любого существующего репозитория сразу
- ✅ Не нужно «публиковать» в отдельный реестр
- ✅ Истинный источник версий — Git
- ✅ Работает с приватными серверами без доп. настроек

#### Buf: «Сначала реестр»
```yaml
# buf.yaml — ссылки только на модули BSR
version: v1
deps:
  - buf.build/googleapis/googleapis
  - buf.build/grpc/grpc
  - buf.build/envoyproxy/protoc-gen-validate
```

**Преимущества:**
- ✅ Курируемые, проверенные модули
- ✅ Богатые метаданные и документация
- ✅ Визуализация графа зависимостей
- ✅ Принуждение семантического версионирования

**Ограничения:**
- ❌ Нужно опубликовать в BSR перед использованием
- ❌ Требует аккаунт и аутентификацию
- ❌ Нельзя напрямую сослаться на произвольный Git репозиторий

### 2. Корпоративные и изолированные (air‑gapped) среды

#### EasyP: Полноценная оффлайн‑поддержка

**Сценарий**: крупная компания со строгими сетевыми политиками

```bash
# 1. Среда с доступом в интернет
easyp mod download          # Скачивает в ~/.easyp/
easyp mod vendor            # Создает easyp_vendor/

# 2. Перенос в изолированный сегмент
tar -czf easyp-deps.tar.gz ~/.easyp easyp_vendor/
# ... перенос архива ...

# 3. В изолированной среде
tar -xzf easyp-deps.tar.gz
export EASYPPATH=$PWD/.easyp
easyp generate              # Работает оффлайн
```

**Плюсы:**
- ✅ Не зависит от внешних сервисов
- ✅ Не нужен внутренний реестр
- ✅ Использует существующую Git инфраструктуру
- ✅ Простая файловая дистрибуция

#### Buf: Требует инфраструктуру реестра

```bash
# Вариант 1: использовать buf.build (нужен интернет)
buf mod download

# Вариант 2: поднимать приватный BSR (сложно)
# - Развернуть сервер реестра
# - Перепубликовать все модули внутрь
# - Настроить доступы, аутентификацию
# - Поддерживать работоспособность
```

**Минусы:**
- ❌ Постоянный интернет или дорогой приватный BSR
- ❌ Сложная инфраструктура для частных установок
- ❌ Все модули нужно републиковать
- ❌ Дополнительные операционные затраты

### 3. Безопасность и контроль

#### EasyP: Прямой контроль
```yaml
# Полный контроль источников
deps:
  # Публичный репозиторий — ваша конкретная версия
  - github.com/googleapis/googleapis@common-protos-1_3_1

  # Внутренний репозиторий
  - gitlab.company.com/security/validated-protos@v1.0.0

  # Точный коммит (горячий фикс)
  - github.com/bufbuild/protoc-gen-validate@abc123def456
```

**Преимущества по безопасности:**
- ✅ Нет посредника — берём из исходного репозитория
- ✅ Аудит через историю Git
- ✅ Нельзя «забанить» доступ извне
- ✅ Свои процессы сканирования / валидации
- ✅ Можно форкнуть и удерживать критические версии

#### Buf: Зависимость от реестра
```yaml
deps:
  - buf.build/googleapis/googleapis
  - buf.build/grpc/grpc
```

**Риски:**
- ⚠️ Посредник контролирует доступность
- ⚠️ Возможны ограничения / санкции на аккаунт
- ⚠️ Модуль могут удалить или депрекейтнуть
- ⚠️ Политики обновлений диктуются стороной
- ⚠️ Нужно доверять внешней безопасности

### 4. Реальные сценарии

#### Сценарий 1: Стартап с публичными зависимостями

**EasyP:**
```yaml
deps:
  - github.com/googleapis/googleapis
  - github.com/grpc-ecosystem/grpc-gateway@v2.19.1
```

**Buf:**
```yaml
deps:
  - buf.build/googleapis/googleapis
  - buf.build/grpcecosystem/grpc-gateway
```

**Итог:** Паритет — оба хорошо подходят для публичных пакетов.

#### Сценарий 2: Компания со смешанными публичными/приватными зависимостями

**EasyP:**
```yaml
deps:
  - github.com/googleapis/googleapis@v1.2.3
  - github.com/mycompany/auth-protos@v2.0.0
  - gitlab.enterprise.com/platform/shared-types@v1.5.1
```

**Buf:**
```yaml
deps:
  - buf.build/googleapis/googleapis
  - buf.build/mycompany/auth-protos
  - buf.build/mycompany/shared-types
```

**Итог:** **EasyP** — не требует публикации внутрь BSR.

#### Сценарий 3: Государственный / оборонный подрядчик (полный air‑gap)

**EasyP:**
```bash
easyp mod vendor
# Архив → перенос → распаковка → generate (без сети)
```

**Buf:**
```bash
# Нужен приватный BSR с поддержкой полного оффлайна
# Сложный цикл публикации и обслуживания
```

**Итог:** **EasyP** — значительно проще.

#### Сценарий 4: Комплаенс и аудит

**EasyP:**
- ✅ Прямой аудит изменений (коммиты)
- ✅ Нет внешних точек зависимости в проде
- ✅ Повторяемость через фиксированные коммиты / vendor
- ✅ Управление уязвимостями — в ваших руках

**Buf:**
- ⚠️ Нужно учитывать BSR в области аудита
- ⚠️ Дополнительный риск третьей стороны
- ⚠️ Модули — внешние контролируемые артефакты
- ⚠️ Сложнее трассировать от реестра к исходникам

**Итог:** **EasyP** — проще для комплаенса.

### 5. Стоимость и инфраструктура

#### EasyP: Нулевая дополнительная инфраструктура

**Затраты:**
- ✅ $0 — используете существующий Git
- ✅ Нет дополнительных сервисов/серверов
- ✅ Нет лицензирования
- ✅ Масштабирование в рамках Git

**Инфраструктура:**
- Использует текущие репозитории (GitHub/GitLab/и т.д.)
- Аутентификация — штатная
- Резервирование/DR — как уже настроено для Git

#### Buf: Затраты на реестр

**Hosted BSR (buf.build):**
- ✅ Бесплатный уровень
- ❌ Платные тарифы для приватного и расширенного использования
- ❌ Потенциальные изменения ценовой политики
- ❌ Вопросы локализации данных

**Приватный BSR:**
- ❌ Серверы, БД, балансировка
- ❌ Мониторинг, обновления, бэкапы
- ❌ Лицензирование enterprise функционала
- ❌ Доп. планирование отказоустойчивости

### 6. Миграция и lock‑in

#### EasyP: Нет привязки

**Миграция ИЗ EasyP:**
```yaml
deps:
  - github.com/googleapis/googleapis@v1.2.3
```
(Обычные Git ссылки — легко перенести в другой инструмент.)

**Миграция В EasyP:**
```bash
# Просто указываете те же Git репозитории
```

#### Buf: Потенциальный lock‑in

**Миграция ИЗ Buf:**
- ❌ Нужно сопоставить BSR модули с исходными Git репо
- ❌ Имена модулей BSR не совпадают с URL
- ❌ Возможна потеря удобных метаданных
- ❌ Сложно при глубокой интеграции с BSR

**Миграция В Buf:**
- ❌ Нужно опубликовать всё в BSR
- ❌ Нельзя ссылаться напрямую на Git
- ❌ Принять workflow BSR (push/pull модулей)

## Когда выбирать каждое решение

### Выберите EasyP, если:

✅ **Air‑gapped / закрытые среды**
- Нужна работа без внешних сервисов
- Строгий комплаенс / контроль цепочки поставок

✅ **Фокус на безопасности**
- Контроль источников зависимостей
- Минимизация рисков третьих сторон

✅ **Git‑центричная культура**
- Частные репозитории — норма
- Не хотите добавлять новый ключевой сервис

✅ **Ограниченный бюджет**
- Минимизация операционных расходов
- Предсказуемая стоимость = 0

✅ **Смешанные публичные/частные зависимости**
- Не хотите перекладывать всё в реестр
- Нужна гибкость форматов и размещения

### Выберите Buf, если:

✅ **Глубокая интеграция в экосистему BSR**
- Уже используете линтеры / генерацию Buf
- Нужны курируемые официальные модули
- Важны метаданные и граф зависимостей

✅ **Сотрудничество и открытая разработка**
- Централизованное обнаружение модулей
- Совместная работа над общими пакетами

✅ **Команда новичков в protobuf**
- Требуется «направляющая» структура
- Ценность документации внутри реестра

✅ **Небольшой набор публичных зависимостей**
- В основном используете популярные общие пакеты
- Вас устраивает зависимость от BSR

## Пути миграции

### Переход с Buf на EasyP

1. Найдите исходные Git репозитории для каждого модуля BSR  
2. Сопоставьте имена BSR → Git ссылки (с версиями/тегами)  
3. Обновите конфигурацию (`easyp.yaml`)  
4. Протестируйте генерацию и совместимость  

```yaml
# Было (buf.yaml)
deps:
  - buf.build/googleapis/googleapis
  - buf.build/grpc/grpc

# Стало (easyp.yaml)
deps:
  - github.com/googleapis/googleapis@common-protos-1_3_1
  - github.com/grpc/grpc@v1.50.0
```

### Переход с EasyP на Buf

1. Опубликуйте используемые репозитории как модули BSR  
2. Настройте аутентификацию / организацию Buf  
3. Замените Git ссылки на BSR модули  
4. Перейдите к push/pull workflow Buf  

## Заключение

Оба инструмента решают задачу управления зависимостями protobuf, но подходят под разные приоритеты:

**Сильные стороны EasyP:**
- Корпоративные / изолированные среды
- Жёсткие требования безопасности и аудита
- Минимальные затраты и отсутствие доп. инфраструктуры
- Прямое использование Git (без промежуточного слоя)
- Простота масштабирования

**Сильные стороны Buf:**
- Богатая экосистема вокруг реестра
- Курируемые и документированные модули
- Удобство для новых команд в protobuf
- Средства визуализации и централизованного обмена

Выбор часто сводится к балансу между **контролем vs. удобством**, **безопасностью vs. централизованными функциями**, и **стоимостью vs. managed‑сервисом**.

Для большинства enterprise‑окружений децентрализованный Git‑подход EasyP обеспечивает нужные гибкость, безопасность и предсказуемость расходов, тогда как Buf отлично подходит командам, которым важна централизованная коллаборация и богатая экосистема вокруг реестра.
